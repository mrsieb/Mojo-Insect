name: Build & Test

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]

env:
  BUILD_TYPE: Release
  # pluginval version to download
  PLUGINVAL_VERSION: "1.0.3"

jobs:
  build:
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          # ── macOS (Apple Silicon) ──────────────────────────────────────────
          - name: macOS (arm64)
            os: macos-14          # M1 runner
            cmake_flags: >-
              -DCMAKE_OSX_ARCHITECTURES=arm64
              -DCMAKE_OSX_DEPLOYMENT_TARGET=11.0
            artifact_vst3: MojoInsects_artefacts/VST3/MojoInsects.vst3
            artifact_au:   MojoInsects_artefacts/AU/MojoInsects.component
            pluginval_url: https://github.com/Tracktion/pluginval/releases/download/v${{ env.PLUGINVAL_VERSION }}/pluginval_macOS.zip
            codesign: true

          # ── macOS (Intel) ──────────────────────────────────────────────────
          - name: macOS (x86_64)
            os: macos-13
            cmake_flags: >-
              -DCMAKE_OSX_ARCHITECTURES=x86_64
              -DCMAKE_OSX_DEPLOYMENT_TARGET=10.15
            artifact_vst3: MojoInsects_artefacts/VST3/MojoInsects.vst3
            artifact_au:   MojoInsects_artefacts/AU/MojoInsects.component
            pluginval_url: https://github.com/Tracktion/pluginval/releases/download/v${{ env.PLUGINVAL_VERSION }}/pluginval_macOS.zip
            codesign: true

          # ── Windows ───────────────────────────────────────────────────────
          - name: Windows (x64)
            os: windows-latest
            cmake_flags: -A x64
            artifact_vst3: MojoInsects_artefacts/VST3/MojoInsects.vst3
            pluginval_url: https://github.com/Tracktion/pluginval/releases/download/v${{ env.PLUGINVAL_VERSION }}/pluginval_Windows.zip
            codesign: true

          # ── Linux ─────────────────────────────────────────────────────────
          - name: Linux (x86_64)
            os: ubuntu-latest
            cmake_flags: ""
            artifact_vst3: MojoInsects_artefacts/VST3/MojoInsects.vst3
            pluginval_url: https://github.com/Tracktion/pluginval/releases/download/v${{ env.PLUGINVAL_VERSION }}/pluginval_Linux.zip
            codesign: false  # No codesigning on Linux

    steps:
      # ── Checkout ────────────────────────────────────────────────────────────
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # ── Linux system dependencies ────────────────────────────────────────
      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update -y
          sudo apt-get install -y \
            libasound2-dev \
            libx11-dev \
            libxinerama-dev \
            libxext-dev \
            libfreetype6-dev \
            libwebkit2gtk-4.0-dev \
            libglu1-mesa-dev \
            libcurl4-openssl-dev \
            ninja-build

      # ── macOS Xcode ─────────────────────────────────────────────────────
      - name: Select Xcode (macOS)
        if: runner.os == 'macOS'
        run: sudo xcode-select -s /Applications/Xcode_15.4.app

      # ── CPM cache ────────────────────────────────────────────────────────
      - name: Cache CPM packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/CPM
          key: cpm-${{ runner.os }}-${{ hashFiles('CMakeLists.txt', 'cmake/CPM.cmake') }}
          restore-keys: cpm-${{ runner.os }}-

      # ── Configure ────────────────────────────────────────────────────────
      - name: Configure CMake
        run: >
          cmake -B build
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
          ${{ matrix.cmake_flags }}

      # ── Build ────────────────────────────────────────────────────────────
      - name: Build
        run: cmake --build build --config ${{ env.BUILD_TYPE }} --parallel

      # ── Unit tests (Catch2 via CTest) ────────────────────────────────────
      - name: Run Catch2 tests
        run: ctest --test-dir build -C ${{ env.BUILD_TYPE }} --output-on-failure

      # ── pluginval ─────────────────────────────────────────────────────────
      - name: Download pluginval
        run: |
          curl -fsSL "${{ matrix.pluginval_url }}" -o pluginval.zip
          unzip -o pluginval.zip -d pluginval_dir

      - name: Validate VST3 (pluginval)
        if: runner.os != 'Linux'   # pluginval Linux support is limited
        shell: bash
        run: |
          if [ "${{ runner.os }}" = "macOS" ]; then
            PLUGINVAL=./pluginval_dir/pluginval.app/Contents/MacOS/pluginval
          else
            PLUGINVAL=./pluginval_dir/pluginval.exe
          fi
          $PLUGINVAL \
            --validate-in-process \
            --strictness-level 5 \
            "build/${{ matrix.artifact_vst3 }}" || true

      # ══════════════════════════════════════════════════════════════════════
      # CODESIGNING — skipped entirely when secrets are absent.
      # Each step checks for the relevant secret before running.
      # ══════════════════════════════════════════════════════════════════════

      # ── macOS: import certificate ────────────────────────────────────────
      - name: "[macOS] Import Developer ID certificate"
        if: >
          runner.os == 'macOS'
          && matrix.codesign
          && secrets.APPLE_CERT_BASE64 != ''
        env:
          CERT_BASE64:  ${{ secrets.APPLE_CERT_BASE64 }}
          CERT_PASSWORD: ${{ secrets.APPLE_CERT_PASSWORD }}
        run: |
          KEYCHAIN_PATH="$RUNNER_TEMP/build.keychain"
          KEYCHAIN_PASSWORD="$(openssl rand -hex 16)"
          echo "$CERT_BASE64" | base64 --decode > /tmp/cert.p12
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security import /tmp/cert.p12 -k "$KEYCHAIN_PATH" \
            -P "$CERT_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security
          security list-keychain -d user -s "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple: -s \
            -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

      - name: "[macOS] Codesign VST3"
        if: >
          runner.os == 'macOS'
          && matrix.codesign
          && secrets.APPLE_CERT_BASE64 != ''
        run: |
          codesign --force --deep --sign "Developer ID Application" \
            "build/${{ matrix.artifact_vst3 }}"

      - name: "[macOS] Codesign AU"
        if: >
          runner.os == 'macOS'
          && matrix.codesign
          && matrix.artifact_au != ''
          && secrets.APPLE_CERT_BASE64 != ''
        run: |
          codesign --force --deep --sign "Developer ID Application" \
            "build/${{ matrix.artifact_au }}"

      - name: "[macOS] Notarize"
        if: >
          runner.os == 'macOS'
          && matrix.codesign
          && secrets.APPLE_TEAM_ID != ''
          && secrets.APPLE_ID != ''
          && secrets.APPLE_ID_PASSWORD != ''
        env:
          APPLE_TEAM_ID:       ${{ secrets.APPLE_TEAM_ID }}
          APPLE_ID:            ${{ secrets.APPLE_ID }}
          APPLE_ID_PASSWORD:   ${{ secrets.APPLE_ID_PASSWORD }}
        run: |
          ditto -c -k --keepParent "build/${{ matrix.artifact_vst3 }}" /tmp/MojoInsects_VST3.zip
          xcrun notarytool submit /tmp/MojoInsects_VST3.zip \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_ID_PASSWORD" \
            --team-id "$APPLE_TEAM_ID" \
            --wait
          xcrun stapler staple "build/${{ matrix.artifact_vst3 }}"

      # ── Windows: codesign with SignTool ───────────────────────────────────
      - name: "[Windows] Import certificate"
        if: >
          runner.os == 'Windows'
          && matrix.codesign
          && secrets.WINDOWS_CERT_BASE64 != ''
        env:
          CERT_BASE64:    ${{ secrets.WINDOWS_CERT_BASE64 }}
          CERT_PASSWORD:  ${{ secrets.WINDOWS_CERT_PASSWORD }}
        shell: pwsh
        run: |
          $certBytes = [Convert]::FromBase64String($env:CERT_BASE64)
          $certPath  = "$env:RUNNER_TEMP\cert.pfx"
          [IO.File]::WriteAllBytes($certPath, $certBytes)
          $securePwd = ConvertTo-SecureString $env:CERT_PASSWORD -AsPlainText -Force
          Import-PfxCertificate -FilePath $certPath -CertStoreLocation Cert:\CurrentUser\My -Password $securePwd

      - name: "[Windows] Sign VST3 with SignTool"
        if: >
          runner.os == 'Windows'
          && matrix.codesign
          && secrets.WINDOWS_CERT_BASE64 != ''
        shell: pwsh
        run: |
          $signtool = & "${env:ProgramFiles(x86)}\Windows Kits\10\bin\10.0.22621.0\x64\signtool.exe"
          & signtool sign /a /fd SHA256 /tr http://timestamp.digicert.com /td SHA256 `
            "build\${{ matrix.artifact_vst3 }}"

      # ── Upload artefacts ──────────────────────────────────────────────────
      - name: Upload artefacts
        uses: actions/upload-artifact@v4
        with:
          name: MojoInsects-${{ matrix.name }}
          path: |
            build/${{ matrix.artifact_vst3 }}
            ${{ matrix.artifact_au != '' && format('build/{0}', matrix.artifact_au) || '' }}
          if-no-files-found: warn
