name: Build & Test

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]

env:
  BUILD_TYPE: Release
  # pluginval version to download
  PLUGINVAL_VERSION: "1.0.3"

jobs:
  build:
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          # ── macOS (Apple Silicon) ──────────────────────────────────────────
          - name: macOS (arm64)
            os: macos-14          # M1 runner
            cmake_flags: >-
              -DCMAKE_OSX_ARCHITECTURES=arm64
              -DCMAKE_OSX_DEPLOYMENT_TARGET=11.0
            artifact_vst3: "MojoInsects_artefacts/Release/VST3/Mojo Insects.vst3"
            artifact_au:   "MojoInsects_artefacts/Release/AU/Mojo Insects.component"
            pluginval_os: macOS

          # ── macOS (Intel) ──────────────────────────────────────────────────
          - name: macOS (x86_64)
            os: macos-13
            cmake_flags: >-
              -DCMAKE_OSX_ARCHITECTURES=x86_64
              -DCMAKE_OSX_DEPLOYMENT_TARGET=10.15
            artifact_vst3: "MojoInsects_artefacts/Release/VST3/Mojo Insects.vst3"
            artifact_au:   "MojoInsects_artefacts/Release/AU/Mojo Insects.component"
            pluginval_os: macOS

          # ── Windows ───────────────────────────────────────────────────────
          - name: Windows (x64)
            os: windows-latest
            cmake_flags: -A x64
            artifact_vst3: "MojoInsects_artefacts/Release/VST3/Mojo Insects.vst3"
            artifact_au:   ""
            pluginval_os: Windows

          # ── Linux ─────────────────────────────────────────────────────────
          - name: Linux (x86_64)
            os: ubuntu-latest
            cmake_flags: ""
            artifact_vst3: "MojoInsects_artefacts/Release/VST3/Mojo Insects.vst3"
            artifact_au:   ""
            pluginval_os: Linux

    steps:
      # ── Checkout ────────────────────────────────────────────────────────────
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # ── Linux system dependencies ────────────────────────────────────────
      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update -y
          sudo apt-get install -y \
            libasound2-dev \
            libx11-dev \
            libxinerama-dev \
            libxext-dev \
            libfreetype6-dev \
            libglu1-mesa-dev \
            libcurl4-openssl-dev \
            ninja-build
          # Ubuntu 24.04 ships webkit2gtk 4.1; 22.04 ships 4.0 — try both.
          sudo apt-get install -y libwebkit2gtk-4.1-dev || \
            sudo apt-get install -y libwebkit2gtk-4.0-dev

      # ── macOS Xcode ─────────────────────────────────────────────────────
      - name: Select Xcode (macOS)
        if: runner.os == 'macOS'
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      # ── CPM cache ────────────────────────────────────────────────────────
      # Use a workspace-relative path so the same expression works on all
      # platforms (Linux/macOS/Windows) without needing per-OS logic.
      - name: Cache CPM packages
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/../.cpm-cache
          key: cpm-${{ runner.os }}-${{ hashFiles('CMakeLists.txt', 'cmake/CPM.cmake') }}
          restore-keys: cpm-${{ runner.os }}-

      # ── Configure ────────────────────────────────────────────────────────
      - name: Configure CMake
        env:
          CPM_SOURCE_CACHE: ${{ github.workspace }}/../.cpm-cache
        run: >
          cmake -B build
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
          -DMOJO_ENABLE_ONNX=OFF
          ${{ matrix.cmake_flags }}

      # ── Build ────────────────────────────────────────────────────────────
      - name: Build
        run: cmake --build build --config ${{ env.BUILD_TYPE }} --parallel

      # ── Unit tests (Catch2 via CTest) ────────────────────────────────────
      - name: Run Catch2 tests
        run: ctest --test-dir build -C ${{ env.BUILD_TYPE }} --output-on-failure

      # ── pluginval ─────────────────────────────────────────────────────────
      # Build the URL here in the step — env context is unavailable in strategy.matrix.
      - name: Download pluginval
        run: |
          curl -fsSL "https://github.com/Tracktion/pluginval/releases/download/v${{ env.PLUGINVAL_VERSION }}/pluginval_${{ matrix.pluginval_os }}.zip" -o pluginval.zip
          unzip -o pluginval.zip -d pluginval_dir

      - name: Validate VST3 (pluginval)
        if: runner.os != 'Linux'   # pluginval Linux support is limited
        shell: bash
        run: |
          if [ "${{ runner.os }}" = "macOS" ]; then
            PLUGINVAL=./pluginval_dir/pluginval.app/Contents/MacOS/pluginval
          else
            PLUGINVAL=./pluginval_dir/pluginval.exe
          fi
          $PLUGINVAL \
            --validate-in-process \
            --strictness-level 5 \
            "build/${{ matrix.artifact_vst3 }}" || true

      # ── Upload artefacts ──────────────────────────────────────────────────
      - name: Upload artefacts
        uses: actions/upload-artifact@v4
        with:
          name: MojoInsects-${{ matrix.name }}
          path: |
            build/${{ matrix.artifact_vst3 }}
            ${{ matrix.artifact_au != '' && format('build/{0}', matrix.artifact_au) || '' }}
          if-no-files-found: warn
